<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="../asset/ressource/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../asset/ressource/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../asset/ressource/img/favicon/favicon-16x16.png">
    <link rel="stylesheet" href="/asset/scss/style.css">
    <script defer src="asset/js/script.js"></script>
    <script type="module" src="/asset/js/music-client.js"></script>
    <script type="module" src="/asset/js/game-client.js"></script>
    <title>Mode solo</title>
</head>
<body>
   
    <section id="duelform">
        {{if eq .View "lobby"}}
        <section id="lobby">
            <div class="solo-container">
                <h1>Mode Solo</h1>
                <h2>Choisissez un duel pour commencer</h2>
                <div class="create-duel-container">
                    <a href="/duel-solo?action=create" class="btn btn-sucess" >Créer un nouveau duel</a>
                </div>
                <hr>
                <div class="duel-list">
                    {{range .AllDuels}}
                    <div class="duel-card">
                        <h3>{{.Name}}</h3>
                        <a href="/duel-solo?duelId={{.ID}}" class="btn btn-primary">Jouer ce duel</a>
                    </div>
                    {{end}}
                    {{if not .AllDuels}}<p>Aucun duel n'a été trouvé.</p>{{end}}
                </div>
            </div>
        </section>

    {{else if eq .View "creation"}}
        <div class="solo-container">
            <h1>Créer un nouveau duel</h1>
            <form action="/create-duel" method="POST">
                <div class="form-group">
                    <label for="duelName">Nom du Duel :</label>
                    <input type="text" id="duelName" name="duelName" required>
                </div>
                <hr>
                <h3>Chansons</h3>
                <div id="songs-container"></div>
                <button type="button" id="add-song" class="btn btn-secondary">Ajouter une chanson</button>
                <hr>
                <button type="submit" class="btn btn-primary">Enregistrer le Duel</button>
            </form>
        </div>

        <div id="song-template" style="display: none;">
            <div class="song-entry" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                <label>Niveau :</label> <select name="songPoints[]"> <option value="50">50</option> <option value="40">40</option> <option value="30">30</option> <option value="20">20</option> <option value="10">10</option> </select>
                <label>Titre :</label> <input type="text" name="songTitles[]" required>
                <label>Artiste :</label> <input type="text" name="songArtists[]" required>
                <label>Fichier Paroles (.json) :</label> <input type="text" name="lyricsFiles[]" required>
                <button type="button" class="btn btn-danger remove-song" style="margin-top: 10px;">Supprimer</button>
            </div>
        </div>

        <script>
            document.getElementById('add-song').addEventListener('click', function() {
                const clone = document.getElementById('song-template').cloneNode(true);
                clone.style.display = 'block';
                clone.removeAttribute('id');
                document.getElementById('songs-container').appendChild(clone);
            });
            document.getElementById('songs-container').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-song')) {
                    e.target.closest('.song-entry').remove();
                }
            });
        </script>

    {{else if eq .View "game"}}
        <script>
            window.gameData = {
                duelId: 123,
                songs: [{"level": "50", "index": 0, "title": "Example Title", "artist": "Example Artist", "points": 50}]
            };
        </script>
        
        <section id="soloDuel">
             <div class="solo-container">
                <h1>Mode Solo - {{.CurrentDuel.Name}}</h1>
                </div>
        </section>
        
        <section id="soloDuel">
             <div class="solo-container">
                <h1>Mode Solo - {{.CurrentDuel.Name}}</h1>
                </div>
        </section>

        <script>
             // ...
        </script>

    {{end}}
    </section>

    <section id="soloDuel">
        <div class="solo-container">
            <h1>Mode Solo - {{.DuelName}}</h1>
            
            <div class="difficulty-control">
                <h3>Réglage de la difficulté</h3>
                <p>Pourcentage de masquage des paroles :</p>
                <input type="range" id="difficultySlider" class="difficulty-slider" 
                    min="30" max="70" value="{{.Value}}" step="5">
                <div class="difficulty-value">
                    <span id="difficultyValue">{{.Value}}</span>% masqué
                </div>
            </div>
            
            <div class="controls">
                <button id="startBtn" class="btn btn-primary">Commencer le jeu</button>
                <button id="nextSongBtn" class="btn btn-success" style="display: none;">Chanson suivante</button>
                <button id="revealBtn" class="btn btn-warning" style="display: none;">Révéler paroles</button>
                <button id="sectionModeBtn" class="btn btn-secondary">Mode par section</button>
            </div>
            
            <div class="score-display">
                Score: <span id="scoreValue">{{.ValuePoint}}</span> points
            </div>
            
            <div class="song-info" id="songInfo" style="display: none;">
                <h3 id="currentSongTitle">{{.Titre}}</h3>
                <p id="currentSongArtist">{{.Artiste}}</p>
                <p id="currentLevel">{{.Points}}</p>
            </div>
            
            <div class="section-controls" id="sectionControls">
                <button class="section-btn" data-section="intro">Intro</button>
                <button class="section-btn" data-section="couplet1">Couplet 1</button>
                <button class="section-btn" data-section="refrain">Refrain</button>
                <button class="section-btn" data-section="couplet2">Couplet 2</button>
                <button class="section-btn" data-section="pont">Pont</button>
                <button class="section-btn" data-section="refrain2">Refrain 2</button>
                <button class="section-btn" data-section="outro">Outro</button>
            </div>
            
            <!-- Conteneur pour les paroles -->
            <div class="lyrics-container">
                <div id="lyricsPlaceholder">
                    <p>Cliquez sur "Commencer le jeu" pour démarrer une chanson.</p>
                </div>
                <div id="lyricsContent" style="display: none;"></div>
            </div>
            
        </div>
    </section>

    <script>
        console.log('Chargement du script...');
        
        let currentSession = null;
        let sectionMode = false;
        let currentSongData = null;
        
        const difficultySlider = document.getElementById('difficultySlider');
        const difficultyValue = document.getElementById('difficultyValue');
        const startBtn = document.getElementById('startBtn');
        const nextSongBtn = document.getElementById('nextSongBtn');
        const revealBtn = document.getElementById('revealBtn');
        const sectionModeBtn = document.getElementById('sectionModeBtn');
        const scoreValue = document.getElementById('scoreValue');
        const songInfo = document.getElementById('songInfo');
        const sectionControls = document.getElementById('sectionControls');
        const lyricsContent = document.getElementById('lyricsContent');
        const lyricsPlaceholder = document.getElementById('lyricsPlaceholder');
        
        // Variables du serveur récupérées depuis window.gameData
        const duelId = window.gameData.duelId;
        const availableSongs = window.gameData.songs;
        
        console.log('Duel ID:', duelId);
        console.log('Available songs:', availableSongs);
        
        // Vérification côté client
        if (!duelId || !availableSongs || availableSongs.length === 0) {
            console.error('Données manquantes:', { duelId, availableSongs });
            alert('Erreur: Données de jeu manquantes');
            startBtn.disabled = true;
            startBtn.textContent = 'Données manquantes';
        }
        
        // Vérifier que nous avons les données nécessaires
        if (!duelId) {
            console.error('ID de duel manquant');
            startBtn.disabled = true;
            startBtn.textContent = 'Données manquantes';
            alert('Erreur: ID de duel manquant');
        }
        
        if (!availableSongs || availableSongs.length === 0) {
            console.error('Aucune chanson disponible');
            startBtn.disabled = true;
            startBtn.textContent = 'Aucune chanson';
            alert('Erreur: Aucune chanson disponible');
        }
        
        // Créer une copie pour ne pas modifier l'original
        let remainingSongs = [...availableSongs];
        
        difficultySlider.addEventListener('input', function() {
            difficultyValue.textContent = this.value;
        });

        sectionModeBtn.addEventListener('click', function() {
            sectionMode = !sectionMode;
            this.textContent = sectionMode ? 'Mode normal' : 'Mode par section';
            this.classList.toggle('btn-primary', sectionMode);
            this.classList.toggle('btn-secondary', !sectionMode);
            
            if (currentSession && currentSession.status === 'playing') {
                sectionControls.style.display = sectionMode ? 'flex' : 'none';
            }
        });

        startBtn.addEventListener('click', async () => {
            if (!duelId || !availableSongs.length) {
                alert('Données de jeu manquantes');
                return;
            }
            
            try {
                console.log('Démarrage de la session...', {
                    duelId: duelId,
                    difficultyLevel: parseInt(difficultySlider.value),
                    sectionMode: sectionMode
                });
                
                const response = await fetch('/api/solo-sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        duelId: duelId,
                        difficultyLevel: parseInt(difficultySlider.value),
                        sectionMode: sectionMode
                    })
                });
                
                if (response.ok) {
                    currentSession = await response.json();
                    console.log('Session créée:', currentSession);
                    
                    startBtn.style.display = 'none';
                    revealBtn.style.display = 'inline-block';
                    nextSongBtn.style.display = 'none'; 
                    
                    revealBtn.textContent = "J'ai la réponse !";
                    loadRandomSong();
                } else {
                    const errorText = await response.text();
                    console.error('Erreur serveur:', errorText);
                    alert("Erreur lors de la création de la session: " + errorText);
                }
            } catch (error) {
                console.error('Erreur lors du démarrage:', error);
                alert("Erreur de connexion au serveur");
            }
        });

        revealBtn.addEventListener('click', async () => {
            if (!currentSession) return;

            // Afficher les paroles complètes
            lyricsContent.innerHTML = currentSession.lyricsContent.replace(/\n/g, '<br>');

            // Mettre à jour le score
            await updateScoreOnServer(currentSongData.points, 'complete');

            revealBtn.style.display = 'none';
            nextSongBtn.style.display = 'inline-block';
        });

        nextSongBtn.addEventListener('click', async () => {
            if (remainingSongs.length > 0) {
                loadRandomSong();
            } else {
                await finishSession();
            }
        });

        sectionControls.addEventListener('click', async (e) => {
            if (e.target.classList.contains('section-btn')) {
                const sectionName = e.target.dataset.section;
                if (!e.target.disabled) {
                    await revealSection(sectionName);
                    e.target.disabled = true; 
                    e.target.classList.add('active');
                }
            }
        });

        async function loadRandomSong() {
            if (remainingSongs.length === 0) {
                await finishSession();
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * remainingSongs.length);
            currentSongData = remainingSongs.splice(randomIndex, 1)[0];
            
            console.log('Chargement de la chanson:', currentSongData);
            
            try {
                const response = await fetch(`/api/solo-sessions/${currentSession.id}/start-song`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level: currentSongData.level,
                        songIndex: currentSongData.index,
                        difficultyLevel: parseInt(difficultySlider.value),
                        sectionMode: sectionMode
                    })
                });
                
                if (response.ok) {
                    currentSession = await response.json();
                    console.log('Chanson chargée:', currentSession);
                    displaySong(currentSession);
                } else {
                    const errorText = await response.text();
                    console.error('Erreur lors du chargement:', errorText);
                    loadRandomSong(); // Essayer une autre chanson
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la chanson:', error);
            }
        }

        function displaySong(sessionData) {
            document.getElementById('currentSongTitle').textContent = sessionData.currentSong.Title;
            document.getElementById('currentSongArtist').textContent = 'par ' + sessionData.currentSong.Artist;
            document.getElementById('currentLevel').textContent = 'Niveau: ' + sessionData.currentLevel + ' points';
            
            songInfo.style.display = 'block';
            lyricsPlaceholder.style.display = 'none';
            lyricsContent.style.display = 'block';
            lyricsContent.innerHTML = sessionData.maskedLyrics;

            revealBtn.style.display = 'inline-block';
            revealBtn.textContent = "J'ai la réponse !";
            nextSongBtn.style.display = 'none';
            sectionControls.style.display = sectionMode ? 'flex' : 'none';
            
            // Réinitialiser les boutons de section
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('active');
            });
        }

        async function revealSection(sectionName) {
            if (!currentSession) return;
            try {
                const response = await fetch(`/api/solo-sessions/${currentSession.id}/reveal-section`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ section: sectionName })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Section révélée:', data);
                    
                    // Mettre à jour le score
                    scoreValue.textContent = data.score; 
                    currentSession.score = data.score;

                    // Révéler la section dans l'affichage
                    const sectionDiv = document.querySelector(`div[data-section="${sectionName}"]`);
                    if (sectionDiv) {
                        const originalSection = extractOriginalSection(currentSession.lyricsContent, sectionName);
                        sectionDiv.innerHTML = `<strong>[${capitalizeFirstLetter(sectionName)}]</strong><br>${originalSection.replace(/\n/g, '<br>')}`;
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la révélation de la section:', error);
            }
        }

        async function updateScoreOnServer(points, action) {
            if (!currentSession) return;
            try {
                const response = await fetch(`/api/solo-sessions/${currentSession.id}/update-score`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ points, action })
                });
                
                if (response.ok) {
                    const updatedSession = await response.json();
                    currentSession.score = updatedSession.score;
                    scoreValue.textContent = currentSession.score; 
                }
            } catch (error) {
                console.error("Erreur lors de la mise à jour du score:", error);
            }
        }

        async function finishSession() {
            if (!currentSession) return;
            try {
                const response = await fetch(`/api/solo-sessions/${currentSession.id}/finish`, {
                    method: 'POST',
                });
                
                if (response.ok) {
                    const finalSession = await response.json();
                    alert(`Jeu terminé ! Score final : ${finalSession.score} points`);
                    location.reload();
                }
            } catch (error) {
                console.error("Erreur lors de la finalisation de la session:", error);
            }
        }

        function extractOriginalSection(fullLyrics, sectionName) {
            const lines = fullLyrics.split('\n');
            let inSection = false;
            const sectionLines = [];
            const sectionHeader = `[${capitalizeFirstLetter(sectionName)}]`;
            
            for (const line of lines) {
                if (line.trim().toLowerCase().includes(`[${sectionName.toLowerCase()}]`)) {
                    inSection = true;
                    continue;
                }
                if (line.trim().startsWith('[')) {
                    inSection = false;
                }
                if (inSection && line.trim() !== '') {
                    sectionLines.push(line);
                }
            }
            return sectionLines.join('\n');
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        console.log('Script complètement chargé');
    </script>
</body>
</html>